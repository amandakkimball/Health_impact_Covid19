---
title: "BRFSS 2017 Survey EDA-BMI"
author: "Amanda Kimball"
date: "11/2/2020"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The Smart: City and county survey data put together by the Center for Disease Control and Prevention: Behavioral risk factor surveillance system (Smart data, 2017). Contains a number of survey response data that is equally distributed across a range of areas referred to as Metropolitan and Micropolitan statistical areas. The survey data covers health indicators, diet choices, health insurance availability, demographics, and economic factors. I initially uploaded the data and pulled out the data related to body mass index and age demographics. My study is focused on individuals age 18-64. 

```{r}
library(foreign)
BRFSS2017 <- read.xport("MMSA2017.XPT")
```

I needed to create an additional factor with the county MMSA name and state separated from the full MMSANAME field. I used the gsub function to remove the MSA test and created the 2 new columns.

```{r}
data <- subset(BRFSS2017, select = c(47:49, 122:129, 177))
data$County <- lapply(data$MMSANAME, as.character)

data$County <- gsub(", Metropolitan Statistical Area", "", data$County)
data$County <- gsub(", Micropolitan Statistical Area", "", data$County)
data$County <- gsub(", Metropolitan Division", "", data$County)
data$State <- gsub(".*,", "", data$County)
data$State <- gsub(" ", "", data$State)
data$County <- gsub(",.*", "", data$County)
str(data)
```

Here are the counties. I use this listing to compare this data to other data sources for specifics on MMSA name alignment.

```{r}
table(data$County)
```

I am focusing on adults between 18-64 for the analysis and will eliminate all younger and older participants, so I remove the older and younger participants.

```{r}
data <- data[(data$X_AGE65YR == 1),]
summary(data$X_AGE80)
```

Here are the calculated body mass indicator variables. As shown there are several missing values.

```{r}
summary(data[9:11])
```

There are a significant number of NA's for the BMI index. I am going to focus on one county's data to understand the nuances in the data set and then apply what I have learned to the other counties. Aberdeen has 25 NA values of 261 entries for the BMI indexes (~9% of the entries which is consistent with the population). There are 2 values listed as pregnant (rows 311 & 453). I can safely remove the individuals listed as pregnant as outliers with a cause. It appears that the remaining values are missing the weight or height factor either listed as 9999 (Refused) or 7777 (Not sure).

```{r}
Aberdeen <- data[data$County == "Aberdeen",]
```

I calculated the average for the Aberdeen and compared it with the average for the data and find that they are 28.5 and 27.6 kg/m2. Note that the documentation indicates a 2 decimal place value. Based off this analysis, I am going to impute the average for the population as the NAs.
```{r}
Aberdeenavg <- mean(Aberdeen$X_BMI5,na.rm=TRUE)
popavg <- mean(data$X_BMI5, na.rm=TRUE)
```

As indicated during the Aberdeen review - pregnant individuals can be removed as outliers outside the range of this analysis. The average BMI will be added otherwise. The BMI average is 28.5 so the BMI5CAT variable is over wieght = 3 and the RFBMI5 is over 25 = 2.

```{r}
data <- data[!(data$PREGNANT == 1),]
index <- is.na(data$X_BMI5)
data$X_BMI5[index] <- popavg
data$X_BMI5CAT[index] <- 3
data$X_RFBMI5[index] <- 2
summary(data[9:11])
```

I plot a histogram of the data and find that most of the data sits in the 25-30 kg/m2 range. The ~10,000 that I added did not significantly change the data structure.

```{r}
hist(data$X_BMI5/100, xlab = "BMI (kg/m2)", breaks = 20)
```

The distribution of BMI does not correlate with age.

```{r}
plot(data$X_AGE80, data$X_BMI5/100, ylab = "BMI (kg/m2)", xlab = "Age (yrs)", lwd = 10, col = "grey60")
```

Extreme Obesity is defined as over 40 kg/m2 but was not segregated in the original dataset. I will add that level to the data for the visualizations and gives another level of detail towards poor health conditions.

```{r}
data$X_BMI5CAT[data$X_BMI5 > 4000] <- 5
summary(data[9:11])
```

I will aggregate the data as an average BMI by county (MMSA Region).

```{r}
MMSABMI <- aggregate(data$X_BMI5/100~data$County, FUN = mean)
names(MMSABMI) <- c("County", "BMI_(kg/m2)")
str(MMSABMI)
```

Then I will create 4 proportion (percentage) values for % underwieght, % Normal wieght, % Overwieght, % Obese, and % extreme obesity by county.

```{r}
state <- data[13:14]
MMSABMI[3:7] <- as.data.frame.matrix(prop.table(table(data$County, data$X_BMI5CAT), 1))*100
MMSABMI <- merge(x = MMSABMI, y = state[!duplicated(data$County),], by = "County")
names(MMSABMI) <- c("MMSANAME", "BMI_(kg/m2)", "%Underweight", "%Normal_weight", "%Overwieght", "%Obese", "%Extreme_Obesity", "State" )
head(MMSABMI)
```

I export this data so that I can create GEO Map data visualizations of the health indicators in Tableau.

```{r}
write.csv(MMSABMI, 'healthdata.csv')
```

References: 

Unknown. (2017) Smart: City and county survey data: 2017 Data. Center for Disease Control and Prevention: Behavioral risk factor surveillance system. Retrieved November 1, 2020 from: https://www.cdc.gov/brfss/smart/Smart_data.htm